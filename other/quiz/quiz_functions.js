const { Canvas, Image } = require('canvas');
const mergeImages = require('merge-images');
const { error } = require('../../helpers.js');
const BSOD = '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';

const getWhosThatPokemonImage = (pokemon) => new Promise((resolve) => {
  mergeImages([
    // Base image
    './assets/images/backdrop/whos_that_pokemon.png',
    { // pokemon image
      src: `./assets/images/pokemon/${pokemon.id}.png`,
      left: 12,
      top: 0,
      custom: (ctx, image) => {
        ctx.fillStyle = '#222';//GameConstants.TypeColor[pokemon.type[0]];
        ctx.fillRect(0, 0, image.width || image.img.width, image.height || image.img.height);
        ctx.globalCompositeOperation = 'destination-in';
      },
    },
  ], {
    Canvas,
    Image,
  }).then(b64 => resolve(b64.split(';base64,').pop()))
    .catch((e) => {
      error('Image not created for pokemon shadow:', pokemon, e);
      resolve(BSOD);
    });
});

const getWhosThatPokemonFinalImage = (pokemon, shiny) => new Promise((resolve) => {
  mergeImages([
    // Base image
    './assets/images/backdrop/whos_that_pokemon.png',
    { // pokemon image
      src: `./assets/images/${shiny ? 'shiny' : ''}pokemon/${pokemon.id}.png`,
      left: 12,
      top: 0,
    },
  ], {
    Canvas,
    Image,
  }).then(b64 => resolve(b64.split(';base64,').pop()))
    .catch((e) => {
      error(`Image not created for ${shiny ? 'shiny' : 'non shiny'} pokemon:`, pokemon, e);
      resolve(BSOD);
    });
});

module.exports = {
  getWhosThatPokemonImage,
  getWhosThatPokemonFinalImage,
};
